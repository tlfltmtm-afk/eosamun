<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì–´ì‚¬ë¬¸ í•œì í•™ìŠµ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fonts-archive/Paperlogy/subsets/Paperlogy-dynamic-subset.css" type="text/css"/>
    <style>
        :root { --topbar-height: 60px; }
        html { scroll-behavior: smooth; overflow-x: hidden; }
        body {
            font-family: "Paperlogy", -apple-system, BlinkMacSystemFont, "Segoe UI",Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            background-color: #FFFDE7; color: #333333;
            padding-top: calc(var(--topbar-height) + 20px); 
        }
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: rgba(255, 140, 0, 0.6); border-radius: 10px; border: 3px solid #FFFDE7; }
        ::-webkit-scrollbar-thumb:hover { background-color: rgba(255, 140, 0, 0.8); }
        
        .interactive-box:focus-visible, button:focus-visible, a:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible {
            outline: none; box-shadow: 0 0 0 3px #FF8C00, 0 0 15px rgba(255, 140, 0, 0.5);
        }

        .kpi-card {
            background-color: white; border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            border: 2px solid transparent;
        }
        
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        
        .kpi-card.ai-highlight {
            border-color: #ef4444; /* red-500 */
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
            transform: scale(1.01);
        }

        .content-section { scroll-margin-top: calc(var(--topbar-height) + 1rem); }
        .vocab-details { 
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
            space-y: 0.5rem;
        }
        #toast-notification {
            transform: translate(-50%, 10px); opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
        }
        #toast-notification.show { transform: translate(-50%, 0); opacity: 1; visibility: visible; }
        
        .modal-popup {
            position: fixed; inset: 0; z-index: 50;
            display: flex; align-items: center; justify-content: center;
            padding: 1rem;
            background-color: rgba(0,0,0,0.4);
            pointer-events: none;
            opacity: 0; visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s;
        }
        .modal-popup.open { 
            opacity: 1; visibility: visible; 
            pointer-events: auto;
        }
        .modal-popup-content {
            background-color: #FFFBEB;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.2), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            width: 90%;
            transform: scale(0.95); opacity: 0;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
        .modal-popup.open .modal-popup-content { transform: scale(1); opacity: 1; }
        
        .syllable-display { gap: 1rem; }
        .syllable-char-box {
            position: relative; padding: 1rem; border-radius: 0.5rem;
            transition: all 0.2s ease-in-out; border: 1px solid #d1d5db;
            text-align: center;
            background-color: white;
        }
        .syllable-char-box:hover { background-color: #FEF3C7; border-color: #FDBA74; }
        .syllable-char-box .hangul { font-size: 2.25rem; font-weight: bold; }
        .syllable-char-box .hanja {
            font-size: 0.8rem; color: #FF8C00;
            position: absolute; right: 0.5rem; bottom: 0.5rem;
        }
        
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .error-memo-textarea {
            width: 100%;
            padding: 4px 8px;
            margin-top: 6px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
            resize: vertical;
            min-height: 40px;
        }
    </style>
</head>
<body class="antialiased">

    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="icon-home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></symbol>
        <symbol id="icon-search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></symbol>
        <symbol id="icon-youtube" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 17a24.12 24.12 0 0 1 0-10C2.5 6 7.5 4 12 4s9.5 2 9.5 3a24.12 24.12 0 0 1 0 10c0 1-5 3-9.5 3s-9.5-2-9.5-3Z"></path><path d="m10 8 6 4-6 4Z"></path></symbol>
        <symbol id="icon-naver-dict" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></symbol>
        <symbol id="icon-google-img" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></symbol>
        <symbol id="icon-arrow-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></symbol>
        <symbol id="icon-more-vertical" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></symbol>
        <symbol id="icon-syllable-analysis" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="2"></circle><circle cx="12" cy="16" r="2"></circle></symbol>
        <symbol id="icon-ai-text" viewBox="0 0 24 24"><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="15" font-weight="bold" fill="currentColor">AI</text></symbol>
        <symbol id="icon-copy" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></symbol>
        <symbol id="icon-expand" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></symbol>
    </svg>

    <div class="max-w-screen-2xl mx-auto lg:grid lg:grid-cols-12 lg:gap-x-8 px-4">
        <div class="lg:col-span-8 xl:col-span-9">
            <div class="relative min-h-screen">
                <header id="topbar" class="fixed top-0 left-0 right-0 z-20 shadow-md bg-[#FFD700]/80 backdrop-blur-sm transition-transform duration-300" style="height: var(--topbar-height);">
                    <div class="flex justify-center items-center h-full px-4 max-w-5xl mx-auto">
                        <div class="flex items-center space-x-6">
                            <a href="index.html" class="p-2 rounded-full hover:bg-black/10 transition-colors" title="í™ˆ"><svg class="w-7 h-7 text-amber-900"><use href="#icon-home"></use></svg></a>
                            <a href="search.html" class="p-2 rounded-full hover:bg-black/10 transition-colors" title="ê²€ìƒ‰í•˜ê¸°"><svg class="w-7 h-7 text-amber-900"><use href="#icon-search"></use></svg></a>
                            <a href="https://chatgpt.com/g/g-6tdiusZks-1-eosamun-wanggwanyujabos" target="_blank" title="ì™•ê´€ìœ ìë´‡" class="p-2 rounded-full hover:bg-black/10 transition-colors"><svg class="w-7 h-7 text-amber-900"><use href="#icon-ai-text"></use></svg></a>
                            <a id="youtube-search-link" href="#" target="_blank" rel="noopener noreferrer" class="p-2 rounded-full hover:bg-black/10 transition-colors" title="YouTubeì—ì„œ ê²€ìƒ‰">
                                <svg class="w-7 h-7 text-amber-900"><use href="#icon-youtube"></use></svg>
                            </a>
                        </div>
                    </div>
                </header>

                <main class="flex-1 p-4 sm:p-6 lg:p-10">
                    <div id="hanja-finder-section" class="max-w-5xl mx-auto mb-8">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-bold mb-4">í•œì IDë¡œ ë°”ë¡œê°€ê¸°</h3>
                            <div class="grid grid-cols-2 gap-4 items-end">
                                <div>
                                    <label for="search-volume" class="block text-sm font-medium text-gray-700">ê¶Œ</label>
                                    <select id="search-volume" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm">
                                        <option value="">ì„ íƒ</option>
                                        <script>for(let i=1; i<=10; i++) document.write(`<option value="${i}">${i}ê¶Œ</option>`);</script>
                                    </select>
                                </div>
                                <div>
                                    <label for="search-number-in-volume" class="block text-sm font-medium text-gray-700">ì—°ë²ˆ</label>
                                    <input type="number" id="search-number-in-volume" min="1" max="200" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm" placeholder="1~200">
                                </div>
                            </div>
                            <button id="goto-hanja-id-btn" class="mt-4 w-full px-4 py-2 bg-orange-500 text-white font-bold rounded-lg hover:bg-orange-600 transition-colors flex-shrink-0">ì´ë™</button>
                        </div>
                    </div>

                    <div id="content-container">
                        </div>
                </main>
            </div>
        </div>
        
        <div class="lg:col-span-4 xl:col-span-3">
            <div id="review-panel" class="sticky top-[20px] space-y-6 py-8 hidden lg:block">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-4">
                        ê²€ìˆ˜ ì§„í–‰ <span id="review-hanja-id" class="text-orange-600 font-mono"></span>
                    </h3>
                    <div class="flex items-center justify-between">
                        <button id="prev-hanja" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors disabled:opacity-50">&lt; ì´ì „</button>
                        <span id="review-progress" class="font-semibold text-lg tabular-nums"></span>
                        <button id="next-hanja" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors disabled:opacity-50">ë‹¤ìŒ &gt;</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-bold">ì˜¤ë¥˜ ì·¨í•©</h3>
                        <div class="flex items-center space-x-2">
                            <button id="expand-errors-btn" title="ìƒˆ íƒ­ì—ì„œ ë³´ê¸°" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                                <svg class="w-5 h-5 text-gray-600"><use href="#icon-expand"></use></svg>
                            </button>
                            <select id="sort-errors-by" class="text-sm rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                                <option value="recent" selected>ìµœì‹  ì…ë ¥ìˆœ</option>
                                <option value="default">ê¸°ë³¸ ì •ë ¬</option>
                                <option value="id-asc">ID ì˜¤ë¦„ì°¨ìˆœ</option>
                                <option value="section">ì„¹ì…˜ë³„</option>
                            </select>
                            <button id="copy-aggregated-errors-btn" title="ì˜¤ë¥˜ ëª©ë¡ ë³µì‚¬" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                                <svg class="w-5 h-5 text-gray-600"><use href="#icon-copy"></use></svg>
                            </button>
                        </div>
                    </div>
                    <div id="aggregated-errors-list" class="max-h-[40rem] overflow-y-auto border rounded-md p-2 bg-gray-50">
                        </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-notification" class="fixed bottom-10 left-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg z-50"></div>
    <div id="syllable-modal" class="modal-popup">
        <div class="modal-popup-content max-w-md">
            <div class="syllable-display flex flex-wrap justify-center items-center text-center"></div>
        </div>
    </div>
    <div id="actions-modal" class="modal-popup">
        <div class="modal-popup-content max-w-xs">
            <div class="actions-popup-content flex justify-around items-center gap-x-4"></div>
        </div>
    </div>

    <script>
    const APPS_SCRIPT_URL = 'YOUR_APPS_SCRIPT_URL_HERE';
    const ALL_ERRORS_STORAGE_KEY = 'hanjaAllErrors';

    function getErrors() {
        return JSON.parse(localStorage.getItem(ALL_ERRORS_STORAGE_KEY) || '{}');
    }

    function saveErrors(errors) {
        localStorage.setItem(ALL_ERRORS_STORAGE_KEY, JSON.stringify(errors));
    }

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch('./data/hanja_db.json');
            if (!response.ok) throw new Error('ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            const allHanjaData = await response.json();

            initializeIdFinder(allHanjaData);
            initializeAggregatedErrors();

            const params = new URLSearchParams(window.location.search);
            const hanjaId = params.get('id');

            if (!hanjaId) {
                document.getElementById('content-container').innerHTML = `
                    <div class="text-center p-10 text-gray-600">
                        <h1 class="text-2xl font-bold">í•œìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</h1>
                        <p>ìœ„ ê²€ìƒ‰ì°½ì—ì„œ IDë‚˜ í›ˆìŒìœ¼ë¡œ í•œìë¥¼ ê²€ìƒ‰í•˜ì—¬ í•™ìŠµì„ ì‹œì‘í•˜ì„¸ìš”.</p>
                    </div>`;
                return;
            }

            const currentHanjaData = allHanjaData.find(item => item.id === hanjaId);

            if (currentHanjaData) {
                renderPage(currentHanjaData, allHanjaData);
                addAllEventListeners(currentHanjaData, allHanjaData);
                initializeReviewPanel(currentHanjaData, allHanjaData);
            } else {
                throw new Error("í•´ë‹¹ IDì˜ í•œì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        } catch (error) {
            console.error("í˜ì´ì§€ ë¡œë”© ì˜¤ë¥˜:", error);
            document.getElementById('content-container').innerHTML = `<p class="text-red-500 text-center">${error.message}</p>`;
        }
    });

    // [ìˆ˜ì •ë¨] renderPage í•¨ìˆ˜ì—ì„œ í•´ì„¤, ë„ì•½ ì„¹ì…˜ ì‚­ì œ
    function renderPage(data, allHanjaData) {
        document.title = `[${data.id.replace('-', 'ê¶Œ_')}] ${data.serial}_${data.huneum}`;
        document.getElementById('youtube-search-link').href = `https://www.youtube.com/@CrownYuja/search?query=${encodeURIComponent(data.huneum)}`;
        
        const contentContainer = document.getElementById('content-container');
        contentContainer.innerHTML = `
            <section id="overview" class="content-section mb-24 md:mb-32">
                <div class="relative grid grid-cols-1 md:grid-cols-3 gap-8 max-w-5xl mx-auto md:items-stretch">
                    <div class="md:col-span-1">
                        <div id="overview-hanja-box" class="interactive-box kpi-card flex-1 flex flex-col items-center justify-center p-8 h-full" tabindex="0">
                            <div class="text-center">
                                <h1 id="main-hanja" class="text-8xl md:text-9xl font-semibold text-orange-600">${data.hanja}</h1>
                                <p id="overview-huneum" class="text-4xl md:text-5xl text-orange-600 mt-4">${data.huneum}</p>
                            </div>
                        </div>
                    </div>
                    <div id="overview-info-box" class="md:col-span-2 kpi-card interactive-box p-8 flex flex-col justify-center" tabindex="0">
                        <div>
                            <h2 class="text-3xl font-bold mb-6 text-[#FF8C00]">í•œì ì •ë³´</h2>
                            <p class="text-xl text-gray-700 mb-3"><strong>ëª©ì°¨:</strong> <span id="overview-index">ì–´ì‚¬ë¬¸ [${data.id.replace('-', 'ê¶Œ_')}]</span></p>
                            <p class="text-xl text-gray-700 mb-3"><strong>ì „ì²´ ì—°ë²ˆ:</strong> <span id="overview-serial">${data.serial}</span></p>
                            <p class="text-xl text-gray-700"><strong>êµê³¼ì„œ ë‹¨ì–´:</strong> <span id="overview-textbook">${data.textbook || 'ì—†ìŒ'}</span></p>
                        </div>
                    </div>
                </div>
            </section>
            <section id="vocabulary" class="content-section mb-24 md:mb-32">
                 <div class="max-w-5xl mx-auto">
                    <h2 class="text-4xl font-bold mb-8 text-left">ğŸ“š ì–´íœ˜</h2>
                    <div class="bg-white p-8 sm:p-10 rounded-lg shadow-lg">
                        <div id="vocabulary-list" class="grid grid-cols-1 gap-6"></div>
                    </div>
                </div>
            </section>`;
        
        const allErrors = getErrors();
        
        const renderItems = (container, dataList, cardCreator) => {
            if (container && dataList?.length > 0) container.innerHTML = dataList.map((item, index) => cardCreator(item, index)).join('');
        };
        
        // [ìˆ˜ì •ë¨] createVocabularyCardHTML í•¨ìˆ˜ ë‹¨ìˆœí™” (isAdvanced ë¡œì§ ì œê±°)
        const createVocabularyCardHTML = (v, index) => {
            const section = 'ì–´íœ˜';
            const vocabTitle = v.title;
            const uniqueId = `${data.id}-${section}-${vocabTitle}`;
            
            const titleHTML = `<h3 class="text-2xl font-bold">${v.title.replace(/(\([^)]+\))/g, '<strong class="font-bold text-orange-600">$1</strong>')}</h3>`;
            const actionsHTML = `<div class="flex items-center">
                <button class="syllable-analysis-btn p-2 rounded-full hover:bg-gray-100" title="ìŒì ˆ ë¶„ì„"><svg class="w-6 h-6 text-gray-500"><use href="#icon-syllable-analysis"></use></svg></button>
                <button class="vocab-actions-toggle flex-shrink-0 p-2 -mr-2 rounded-full hover:bg-gray-100"><svg class="w-6 h-6 text-gray-500"><use href="#icon-more-vertical"></use></svg></button>
            </div>`;
            
            const detailsHTML = `<div class="vocab-details"><p><strong>ëœ»:</strong> ${v.definition}</p><p><strong>êµ¬ì„±:</strong> ${v.composition}</p>${v.analysis ? `<p><strong>í’€ì´:</strong> ${v.analysis}</p>` : ''}<p class="italic"><strong>ì˜ˆ:</strong> ${v.example}</p></div>`;

            return `<div class="kpi-card interactive-box relative p-6" data-word="${vocabTitle}">
                <div class="flex justify-between items-start">
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" class="content-error-checkbox h-5 w-5 rounded border-gray-300 text-orange-600 focus:ring-orange-500" 
                               data-unique-id="${uniqueId}" 
                               data-hanja-id="${data.id}" 
                               data-section="${section}" 
                               data-word="${vocabTitle}" 
                               ${allErrors[uniqueId] ? 'checked' : ''}>
                        ${titleHTML}
                    </div>
                    ${actionsHTML}
                </div>
                ${detailsHTML}
            </div>`;
        };
        
        renderItems(document.getElementById('vocabulary-list'), data.vocabulary, createVocabularyCardHTML);
    }
    
    function addAllEventListeners(hanjaData, allHanjaData) {
        document.querySelectorAll('.syllable-analysis-btn').forEach(btn => btn.addEventListener('click', (e) => handleSyllableAnalysis(e, allHanjaData)));
        document.querySelectorAll('.vocab-actions-toggle').forEach(btn => btn.addEventListener('click', (e) => handleActionsPopup(e)));
        document.querySelectorAll('.content-error-checkbox').forEach(box => box.addEventListener('change', (e) => handleErrorCheck(e, hanjaData)));

        const getBadgeColorClasses = (v) => ['','bg-red-200 text-red-800','bg-blue-200 text-blue-800','bg-green-200 text-green-800','bg-yellow-200 text-yellow-800','bg-indigo-200 text-indigo-800','bg-purple-200 text-purple-800','bg-pink-200 text-pink-800','bg-teal-200 text-teal-800','bg-slate-300 text-slate-800','bg-orange-300 text-orange-800'][parseInt(v, 10)] || '';
        document.querySelectorAll('.vocab-link').forEach(link => link.classList.add(...getBadgeColorClasses(link.dataset.volume).split(' ')));

        window.addEventListener('scroll', handleHeaderScroll, { passive: true });
        document.querySelectorAll('.modal-popup').forEach(modal => {
            modal.addEventListener('click', (e) => { if (e.target === modal) closeAllPopups(); });
        });
    }

    function closeAllPopups() {
        document.querySelectorAll('.modal-popup.open').forEach(p => p.classList.remove('open'));
    }
    
    function handleSyllableAnalysis(e, allHanjaData) {
        const card = e.currentTarget.closest('.kpi-card');
        const title = card.dataset.word;
        e.stopPropagation();
        
        const match = title.match(/([^\(]+)\(([^\)]+)\)/);
        if (!match) return;

        const [_, hangul, hanjaStr] = match;
        document.getElementById('syllable-modal').querySelector('.syllable-display').innerHTML = hangul.split('').map((hangulChar, i) => {
            const hanjaChar = hanjaStr[i];
            const linkedHanja = allHanjaData.find(item => item.hanja === hanjaChar);
            const content = `<div class="hangul">${hangulChar}</div><div class="hanja">${hanjaChar}</div>`;
            return linkedHanja
                ? `<a href="?id=${linkedHanja.id}" class="syllable-char-box block">${content}</a>`
                : `<a href="https://hanja.naver.com/search?query=${encodeURIComponent(hanjaChar)}" target="_blank" class="syllable-char-box block">${content}</a>`;
        }).join('');
        
        document.getElementById('syllable-modal').classList.add('open');
    }
    
    function handleActionsPopup(e) {
        const card = e.currentTarget.closest('.kpi-card');
        const title = card.dataset.word;
        e.stopPropagation();
        
        const actionsContent = document.getElementById('actions-modal').querySelector('.actions-popup-content');
        actionsContent.innerHTML = `
            <button class="ai-link p-3 rounded-full text-purple-500 hover:bg-gray-100" data-word="${title}"><svg class="w-8 h-8"><use href="#icon-ai-text"></use></svg></button>
            <button class="naver-dictionary-link p-3 rounded-full hover:bg-gray-100" data-word="${title}"><svg class="w-7 h-7 text-green-500"><use href="#icon-naver-dict"></use></svg></button>
            <button class="google-image-link p-3 rounded-full hover:bg-gray-100" data-word="${title}"><svg class="w-7 h-7 text-orange-500"><use href="#icon-google-img"></use></svg></button>`;
        
        actionsContent.querySelector('.ai-link').addEventListener('click', handleAiLink);
        actionsContent.querySelector('.naver-dictionary-link').addEventListener('click', (ev) => handleSearchLink(ev, 'https://hanja.naver.com/search?query='));
        actionsContent.querySelector('.google-image-link').addEventListener('click', (ev) => handleSearchLink(ev, 'https://www.google.com/search?tbm=isch&q='));

        document.getElementById('actions-modal').classList.add('open');
    }

    function handleHeaderScroll() {
        const topbar = document.getElementById('topbar');
        if (topbar) topbar.style.transform = window.scrollY > 10 ? 'translateY(-100%)' : 'translateY(0%)';
    }

    function handleSearchLink(e, baseUrl) {
        const title = e.currentTarget.dataset.word;
        if (title) {
            const query = e.currentTarget.classList.contains('google-image-link') ? title.replace(/\(.*\)/, '').trim() : title;
            window.open(`${baseUrl}${encodeURIComponent(query)}`, '_blank');
        }
    }

    async function handleAiLink(e) {
        const title = e.currentTarget.dataset.word;
        if (title) {
            try {
                await navigator.clipboard.writeText(title); 
                showToast('ì–´íœ˜ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'); 
                window.open('https://chatgpt.com/g/g-6tdiusZks-1-eosamun-wanggwanyujabos', '_blank');
            } catch (err) { showToast('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error'); }
        }
    }

    let toastTimeout;
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast-notification');
        toast.textContent = message;
        toast.className = `fixed bottom-10 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-lg z-50 ${type === 'error' ? 'bg-red-600' : 'bg-gray-800'} text-white show`;
        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => { toast.classList.remove('show'); }, 3000);
    }
    
    function initializeIdFinder(allHanjaData) {
        const volumeInput = document.getElementById('search-volume');
        const numInVolumeInput = document.getElementById('search-number-in-volume');
        const gotoBtn = document.getElementById('goto-hanja-id-btn');

        if (!volumeInput || !numInVolumeInput || !gotoBtn) return;
        
        const handleGoToId = () => {
            const volume = volumeInput.value;
            const numInVolume = numInVolumeInput.value;
            let target = null;

            if (volume && numInVolume) {
                const targetId = `${volume}-${numInVolume}`;
                target = allHanjaData.find(item => item.id === targetId);
            }

            if (target) {
                window.location.search = `?id=${target.id}`;
            } else {
                showToast('ìœ íš¨í•œ ê¶Œê³¼ ì—°ë²ˆì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            }
        };

        gotoBtn.addEventListener('click', handleGoToId);
        [volumeInput, numInVolumeInput].forEach(input => {
             input.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleGoToId(); });
        });
    }

    function handleErrorCheck(event, currentHanjaData) {
        const checkbox = event.target;
        const { uniqueId } = checkbox.dataset;
        const errors = getErrors();
        
        if (checkbox.checked) {
            const ds = checkbox.dataset;
            errors[uniqueId] = {
                id: ds.hanjaId,
                hanja: currentHanjaData.hanja,
                huneum: currentHanjaData.huneum,
                errorItem: ds.word,
                errorLocation: ds.section,
                feedback: '',
                suggestion: '',
                memo: '',
                timestamp: Date.now()
            };
        } else {
            delete errors[uniqueId];
        }
        
        saveErrors(errors);
        renderAggregatedErrors();
    }
    
    function renderAggregatedErrors() {
        const container = document.getElementById('aggregated-errors-list');
        const sortMethod = document.getElementById('sort-errors-by').value;
        if (!container) return;
        
        const errors = getErrors();
        let errorItems = Object.entries(errors).map(([uniqueId, data]) => ({ uniqueId, ...data }));
        
        if (sortMethod === 'recent') {
            errorItems.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        } else if (sortMethod === 'id-asc') {
            errorItems.sort((a, b) => a.id.localeCompare(b.id, undefined, {numeric: true}));
        } else if (sortMethod === 'section') {
            errorItems.sort((a, b) => a.errorLocation.localeCompare(b.errorLocation) || a.id.localeCompare(b.id, undefined, {numeric: true}));
        }

        if (errorItems.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-sm p-2">ì²´í¬ëœ ì˜¤ë¥˜ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        container.innerHTML = errorItems.map(({ uniqueId, id, hanja, huneum, errorItem, errorLocation, feedback, suggestion, memo }) => `
            <div class="relative text-sm p-2 border-b last:border-b-0 bg-white">
                <button class="delete-error-btn absolute top-1 right-1 text-gray-400 hover:text-red-500 font-bold text-lg leading-none p-1" data-unique-id="${uniqueId}" title="ì‚­ì œ">&times;</button>
                <p class="font-bold pr-4">${errorItem} <span class="text-xs font-normal text-gray-500">(${errorLocation})</span></p>
                <p class="text-gray-600 text-xs">ID: ${id} (${hanja} ${huneum})</p>
                ${feedback ? `<p class="text-blue-600 text-xs mt-1">í”¼ë“œë°±: ${feedback}</p>` : ''}
                ${suggestion ? `<p class="text-green-600 text-xs mt-1">ìˆ˜ì • ì œì•ˆ: ${suggestion}</p>` : ''}
                <textarea class="error-memo-textarea" data-unique-id="${uniqueId}" placeholder="ë©”ëª¨ ì…ë ¥...">${memo || ''}</textarea>
            </div>
        `).join('');
    }

    function initializeAggregatedErrors() {
        renderAggregatedErrors();

        document.getElementById('sort-errors-by').addEventListener('change', renderAggregatedErrors);
        
        document.getElementById('copy-aggregated-errors-btn').addEventListener('click', () => {
            const errors = getErrors();
            const errorItems = Object.values(errors);
            if (errorItems.length === 0) {
                showToast('ë³µì‚¬í•  ì˜¤ë¥˜ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            const headers = "ID\tí•œì\tí›ˆìŒ\tì˜¤ë¥˜ í•­ëª©\tì˜¤ë¥˜ ìœ„ì¹˜\tí”¼ë“œë°±\tìˆ˜ì • ì œì•ˆ\të©”ëª¨";
            const tsvString = [headers, ...errorItems.map(e => `${e.id}\t${e.hanja}\t${e.huneum}\t${e.errorItem}\t${e.errorLocation}\t${e.feedback}\t${e.suggestion}\t${e.memo || ''}`)].join('\n');
            
            navigator.clipboard.writeText(tsvString).then(() => {
                showToast('ì˜¤ë¥˜ ëª©ë¡ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.open('https://docs.google.com/spreadsheets/d/1jJQIiQD0jKo7kE2JSP7-dlRgUosvU76sWWxor_HrASk/edit?gid=0#gid=0', '_blank');
            }, (err) => {
                showToast('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            });
        });

        document.getElementById('expand-errors-btn').addEventListener('click', () => {
            const errors = getErrors();
            const errorItems = Object.values(errors);
            if (errorItems.length === 0) {
                showToast('í™•ì¥í•  ì˜¤ë¥˜ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            const newWindow = window.open('', '_blank');
            const headers = ["ID", "í•œì", "í›ˆìŒ", "ì˜¤ë¥˜ í•­ëª©", "ì˜¤ë¥˜ ìœ„ì¹˜", "í”¼ë“œë°±", "ìˆ˜ì • ì œì•ˆ", "ë©”ëª¨"];
            let tableHTML = `<style>body{font-family:sans-serif;} table{width:100%; border-collapse:collapse;} th,td{border:1px solid #ccc; padding:8px; text-align:left; vertical-align:top;} th{background-color:#f2f2f2;}</style>
                             <h1>ì˜¤ë¥˜ ì·¨í•© ëª©ë¡</h1>
                             <table><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
            
            errorItems.forEach(e => {
                tableHTML += `<tr>
                    <td>${e.id}</td><td>${e.hanja}</td><td>${e.huneum}</td><td>${e.errorItem}</td>
                    <td>${e.errorLocation}</td><td>${e.feedback}</td><td>${e.suggestion}</td><td>${(e.memo || '').replace(/\n/g, '<br>')}</td>
                </tr>`;
            });
            tableHTML += '</tbody></table>';

            newWindow.document.write(tableHTML);
            newWindow.document.close();
        });
        
        const errorListContainer = document.getElementById('aggregated-errors-list');

        errorListContainer.addEventListener('input', (e) => {
            if (e.target.classList.contains('error-memo-textarea')) {
                const uniqueId = e.target.dataset.uniqueId;
                const errors = getErrors();
                if (errors[uniqueId]) {
                    errors[uniqueId].memo = e.target.value;
                    saveErrors(errors);
                }
            }
        });
        
        errorListContainer.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-error-btn');
            if (deleteBtn) {
                const uniqueId = deleteBtn.dataset.uniqueId;
                const errors = getErrors();
                if (errors[uniqueId]) {
                    delete errors[uniqueId];
                    saveErrors(errors);

                    const correspondingCheckbox = document.querySelector(`.content-error-checkbox[data-unique-id="${uniqueId}"]`);
                    if (correspondingCheckbox) {
                        correspondingCheckbox.checked = false;
                    }
                    renderAggregatedErrors();
                    showToast('ì˜¤ë¥˜ í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
            }
        });
    }
    
    function initializeReviewPanel(currentHanjaData, allHanjaData) {
        const reviewPanel = document.getElementById('review-panel');
        if (!reviewPanel) return;
        reviewPanel.style.display = 'block';
        
        const hanjaIdEl = document.getElementById('review-hanja-id');
        const progressEl = document.getElementById('review-progress');
        const prevBtn = document.getElementById('prev-hanja');
        const nextBtn = document.getElementById('next-hanja');
        
        const currentIndex = allHanjaData.findIndex(item => item.id === currentHanjaData.id);
        
        hanjaIdEl.textContent = `[${currentHanjaData.id.replace('-', 'ê¶Œ_')}] ${currentHanjaData.serial}`;
        progressEl.textContent = `${currentIndex + 1} / ${allHanjaData.length}`;
        prevBtn.disabled = currentIndex === 0;
        nextBtn.disabled = currentIndex === allHanjaData.length - 1;

        const navigateToHanja = (id) => { window.location.search = `?id=${id}`; };
        prevBtn.onclick = () => { if (currentIndex > 0) navigateToHanja(allHanjaData[currentIndex - 1].id); };
        nextBtn.onclick = () => { if (currentIndex < allHanjaData.length - 1) navigateToHanja(allHanjaData[currentIndex + 1].id); };
    }
    </script>
</body>
</html>