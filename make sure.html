<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>어사문 한자 학습</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fonts-archive/Paperlogy/subsets/Paperlogy-dynamic-subset.css" type="text/css"/>
    <style>
        :root { --topbar-height: 60px; }
        html { scroll-behavior: smooth; overflow-x: hidden; }
        body {
            font-family: "Paperlogy", -apple-system, BlinkMacSystemFont, "Segoe UI",Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            background-color: #FFFDE7; color: #333333;
            padding-top: calc(var(--topbar-height) + 20px); 
        }
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: rgba(255, 140, 0, 0.6); border-radius: 10px; border: 3px solid #FFFDE7; }
        ::-webkit-scrollbar-thumb:hover { background-color: rgba(255, 140, 0, 0.8); }
        
        .interactive-box:focus-visible, button:focus-visible, a:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible {
            outline: none; box-shadow: 0 0 0 3px #FF8C00, 0 0 15px rgba(255, 140, 0, 0.5);
        }

        .kpi-card {
            background-color: white; border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            border: 2px solid transparent;
        }
        
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        
        .kpi-card.ai-highlight {
            border-color: #ef4444; /* red-500 */
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
            transform: scale(1.01);
        }

        .content-section { scroll-margin-top: calc(var(--topbar-height) + 1rem); }
        .vocab-details { 
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
            space-y: 0.5rem;
        }
        #toast-notification {
            transform: translate(-50%, 10px); opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s;
        }
        #toast-notification.show { transform: translate(-50%, 0); opacity: 1; visibility: visible; }
        
        .modal-popup {
            position: fixed; inset: 0; z-index: 50;
            display: flex; align-items: center; justify-content: center;
            padding: 1rem;
            background-color: rgba(0,0,0,0.4);
            pointer-events: none;
            opacity: 0; visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s;
        }
        .modal-popup.open { 
            opacity: 1; visibility: visible; 
            pointer-events: auto;
        }
        .modal-popup-content {
            background-color: #FFFBEB;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.2), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            width: 90%;
            transform: scale(0.95); opacity: 0;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
        .modal-popup.open .modal-popup-content { transform: scale(1); opacity: 1; }
        
        .syllable-display { gap: 1rem; }
        .syllable-char-box {
            position: relative; padding: 1rem; border-radius: 0.5rem;
            transition: all 0.2s ease-in-out; border: 1px solid #d1d5db;
            text-align: center;
            background-color: white;
        }
        .syllable-char-box:hover { background-color: #FEF3C7; border-color: #FDBA74; }
        .syllable-char-box .hangul { font-size: 2.25rem; font-weight: bold; }
        .syllable-char-box .hanja {
            font-size: 0.8rem; color: #FF8C00;
            position: absolute; right: 0.5rem; bottom: 0.5rem;
        }
        
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .error-memo-textarea {
            width: 100%;
            padding: 4px 8px;
            margin-top: 6px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
            resize: vertical;
            min-height: 40px;
        }
    </style>
</head>
<body class="antialiased">

    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="icon-home" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></symbol>
        <symbol id="icon-search" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></symbol>
        <symbol id="icon-youtube" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 17a24.12 24.12 0 0 1 0-10C2.5 6 7.5 4 12 4s9.5 2 9.5 3a24.12 24.12 0 0 1 0 10c0 1-5 3-9.5 3s-9.5-2-9.5-3Z"></path><path d="m10 8 6 4-6 4Z"></path></symbol>
        <symbol id="icon-naver-dict" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></symbol>
        <symbol id="icon-google-img" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></symbol>
        <symbol id="icon-arrow-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></symbol>
        <symbol id="icon-more-vertical" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></symbol>
        <symbol id="icon-syllable-analysis" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="2"></circle><circle cx="12" cy="16" r="2"></circle></symbol>
        <symbol id="icon-ai-text" viewBox="0 0 24 24"><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="15" font-weight="bold" fill="currentColor">AI</text></symbol>
        <symbol id="icon-copy" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></symbol>
        <symbol id="icon-expand" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></symbol>
    </svg>

    <div class="max-w-screen-2xl mx-auto lg:grid lg:grid-cols-12 lg:gap-x-8 px-4">
        <div class="lg:col-span-8 xl:col-span-9">
            <div class="relative min-h-screen">
                <header id="topbar" class="fixed top-0 left-0 right-0 z-20 shadow-md bg-[#FFD700]/80 backdrop-blur-sm transition-transform duration-300" style="height: var(--topbar-height);">
                    <div class="flex justify-center items-center h-full px-4 max-w-5xl mx-auto">
                        <div class="flex items-center space-x-6">
                            <a href="index.html" class="p-2 rounded-full hover:bg-black/10 transition-colors" title="홈"><svg class="w-7 h-7 text-amber-900"><use href="#icon-home"></use></svg></a>
                            <a href="search.html" class="p-2 rounded-full hover:bg-black/10 transition-colors" title="검색하기"><svg class="w-7 h-7 text-amber-900"><use href="#icon-search"></use></svg></a>
                            <a href="https://chatgpt.com/g/g-6tdiusZks-1-eosamun-wanggwanyujabos" target="_blank" title="왕관유자봇" class="p-2 rounded-full hover:bg-black/10 transition-colors"><svg class="w-7 h-7 text-amber-900"><use href="#icon-ai-text"></use></svg></a>
                            <a id="youtube-search-link" href="#" target="_blank" rel="noopener noreferrer" class="p-2 rounded-full hover:bg-black/10 transition-colors" title="YouTube에서 검색">
                                <svg class="w-7 h-7 text-amber-900"><use href="#icon-youtube"></use></svg>
                            </a>
                        </div>
                    </div>
                </header>

                <main class="flex-1 p-4 sm:p-6 lg:p-10">
                    <div id="hanja-finder-section" class="max-w-5xl mx-auto mb-8">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-lg font-bold mb-4">한자 ID로 바로가기</h3>
                            <div class="grid grid-cols-2 gap-4 items-end">
                                <div>
                                    <label for="search-volume" class="block text-sm font-medium text-gray-700">권</label>
                                    <select id="search-volume" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm">
                                        <option value="">선택</option>
                                        <script>for(let i=1; i<=10; i++) document.write(`<option value="${i}">${i}권</option>`);</script>
                                    </select>
                                </div>
                                <div>
                                    <label for="search-number-in-volume" class="block text-sm font-medium text-gray-700">연번</label>
                                    <input type="number" id="search-number-in-volume" min="1" max="200" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm" placeholder="1~200">
                                </div>
                            </div>
                            <button id="goto-hanja-id-btn" class="mt-4 w-full px-4 py-2 bg-orange-500 text-white font-bold rounded-lg hover:bg-orange-600 transition-colors flex-shrink-0">이동</button>
                        </div>
                    </div>

                    <div id="content-container">
                        </div>
                </main>
            </div>
        </div>
        
        <div class="lg:col-span-4 xl:col-span-3">
            <div id="review-panel" class="sticky top-[20px] space-y-6 py-8 hidden lg:block">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-4">
                        검수 진행 <span id="review-hanja-id" class="text-orange-600 font-mono"></span>
                    </h3>
                    <div class="flex items-center justify-between">
                        <button id="prev-hanja" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors disabled:opacity-50">&lt; 이전</button>
                        <span id="review-progress" class="font-semibold text-lg tabular-nums"></span>
                        <button id="next-hanja" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors disabled:opacity-50">다음 &gt;</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-bold mb-4">AI 검수 기능</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="api-key-input" class="block text-sm font-medium text-gray-700">Gemini API Key</label>
                            <div class="flex items-center space-x-2 mt-1">
                                <input type="password" id="api-key-input" class="block w-full border-gray-300 rounded-md shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm" placeholder="API 키를 입력하세요">
                                <button id="save-api-key-btn" class="px-4 py-2 bg-gray-600 text-white font-semibold text-sm rounded-md hover:bg-gray-700 transition-colors flex-shrink-0">저장</button>
                            </div>
                        </div>
                        <div>
                            <label for="gemini-model-select" class="block text-sm font-medium text-gray-700">Gemini 모델</label>
                            <select id="gemini-model-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm rounded-md">
                                <option>gemini-1.5-flash-latest</option>
                                <option>gemini-1.5-pro-latest</option>
                            </select>
                        </div>
                        <div>
                            <label for="ai-prompt-textarea" class="block text-sm font-medium text-gray-700">AI 명령어</label>
                            <div class="relative mt-1">
                               <textarea id="ai-prompt-textarea" rows="5" class="block w-full border-gray-300 rounded-md shadow-sm focus:border-orange-500 focus:ring-orange-500 sm:text-sm pr-16"></textarea>
                               <button id="save-ai-prompt-btn" class="absolute bottom-2 right-2 px-3 py-1 bg-gray-600 text-white font-semibold text-xs rounded-md hover:bg-gray-700 transition-colors">저장</button>
                            </div>
                        </div>
                        <button id="run-ai-review-btn" class="w-full px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50">AI 검수 실행</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-bold">오류 취합</h3>
                        <div class="flex items-center space-x-2">
                            <button id="expand-errors-btn" title="새 탭에서 보기" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                                <svg class="w-5 h-5 text-gray-600"><use href="#icon-expand"></use></svg>
                            </button>
                            <select id="sort-errors-by" class="text-sm rounded-md border-gray-300 shadow-sm focus:border-orange-500 focus:ring-orange-500">
                                <option value="default">기본 정렬</option>
                                <option value="id-asc">ID 오름차순</option>
                                <option value="section">섹션별</option>
                            </select>
                            <button id="copy-aggregated-errors-btn" title="오류 목록 복사" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                                <svg class="w-5 h-5 text-gray-600"><use href="#icon-copy"></use></svg>
                            </button>
                        </div>
                    </div>
                    <div id="aggregated-errors-list" class="max-h-96 overflow-y-auto border rounded-md p-2 bg-gray-50">
                        </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="toast-notification" class="fixed bottom-10 left-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg z-50"></div>
    <div id="syllable-modal" class="modal-popup">
        <div class="modal-popup-content max-w-md">
            <div class="syllable-display flex flex-wrap justify-center items-center text-center"></div>
        </div>
    </div>
    <div id="actions-modal" class="modal-popup">
        <div class="modal-popup-content max-w-xs">
            <div class="actions-popup-content flex justify-around items-center gap-x-4"></div>
        </div>
    </div>

    <script>
    const APPS_SCRIPT_URL = 'YOUR_APPS_SCRIPT_URL_HERE';
    const ALL_ERRORS_STORAGE_KEY = 'hanjaAllErrors';

    function getErrors() {
        return JSON.parse(localStorage.getItem(ALL_ERRORS_STORAGE_KEY) || '{}');
    }

    function saveErrors(errors) {
        localStorage.setItem(ALL_ERRORS_STORAGE_KEY, JSON.stringify(errors));
    }

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch('./data/hanja_db.json');
            if (!response.ok) throw new Error('데이터베이스 파일을 불러올 수 없습니다.');
            const allHanjaData = await response.json();

            initializeIdFinder(allHanjaData);
            initializeAggregatedErrors();

            const params = new URLSearchParams(window.location.search);
            const hanjaId = params.get('id');

            if (!hanjaId) {
                document.getElementById('content-container').innerHTML = `
                    <div class="text-center p-10 text-gray-600">
                        <h1 class="text-2xl font-bold">한자를 선택해주세요.</h1>
                        <p>위 검색창에서 ID나 훈음으로 한자를 검색하여 학습을 시작하세요.</p>
                    </div>`;
                return;
            }

            const currentHanjaData = allHanjaData.find(item => item.id === hanjaId);

            if (currentHanjaData) {
                renderPage(currentHanjaData, allHanjaData);
                addAllEventListeners(currentHanjaData, allHanjaData);
                initializeReviewPanel(currentHanjaData, allHanjaData);
                initializeAiReviewPanel(currentHanjaData);
            } else {
                throw new Error("해당 ID의 한자 정보를 찾을 수 없습니다.");
            }
        } catch (error) {
            console.error("페이지 로딩 오류:", error);
            document.getElementById('content-container').innerHTML = `<p class="text-red-500 text-center">${error.message}</p>`;
        }
    });

    function renderPage(data, allHanjaData) {
        document.title = `[${data.id.replace('-', '권_')}] ${data.serial}_${data.huneum}`;
        document.getElementById('youtube-search-link').href = `https://www.youtube.com/@CrownYuja/search?query=${encodeURIComponent(data.huneum)}`;
        
        const contentContainer = document.getElementById('content-container');
        contentContainer.innerHTML = `
            <section id="overview" class="content-section mb-24 md:mb-32">
                <div class="relative grid grid-cols-1 md:grid-cols-3 gap-8 max-w-5xl mx-auto md:items-stretch">
                    <div class="md:col-span-1">
                        <div id="overview-hanja-box" class="interactive-box kpi-card flex-1 flex flex-col items-center justify-center p-8 h-full" tabindex="0">
                            <div class="text-center">
                                <h1 id="main-hanja" class="text-8xl md:text-9xl font-semibold text-orange-600">${data.hanja}</h1>
                                <p id="overview-huneum" class="text-4xl md:text-5xl text-orange-600 mt-4">${data.huneum}</p>
                            </div>
                        </div>
                    </div>
                    <div id="overview-info-box" class="md:col-span-2 kpi-card interactive-box p-8 flex flex-col justify-center" tabindex="0">
                        <div>
                            <h2 class="text-3xl font-bold mb-6 text-[#FF8C00]">한자 정보</h2>
                            <p class="text-xl text-gray-700 mb-3"><strong>목차:</strong> <span id="overview-index">어사문 [${data.id.replace('-', '권_')}]</span></p>
                            <p class="text-xl text-gray-700 mb-3"><strong>전체 연번:</strong> <span id="overview-serial">${data.serial}</span></p>
                            <p class="text-xl text-gray-700"><strong>교과서 단어:</strong> <span id="overview-textbook">${data.textbook || '없음'}</span></p>
                        </div>
                    </div>
                </div>
            </section>
            <section id="meaning" class="content-section mb-24 md:mb-32">
                <div class="max-w-5xl mx-auto">
                    <h2 class="text-4xl font-bold mb-8 text-left">✨ 해설</h2>
                    <div class="bg-white p-8 sm:p-10 rounded-lg shadow-lg">
                        <div id="meaning-explanation-box" class="interactive-box kpi-card p-8 mb-8 bg-amber-50" tabindex="0" data-word="${data.huneum}">
                            <div class="flex items-start space-x-3">
                                <input type="checkbox" class="content-error-checkbox h-5 w-5 rounded border-gray-300 text-orange-600 focus:ring-orange-500 mt-2 flex-shrink-0">
                                <div>
                                    <h3 id="explanation-title" class="text-3xl font-bold mb-4 text-[#FF8C00]">${data.huneum} (<strong class="font-bold">${data.hanja}</strong>)</h3>
                                    <p id="explanation-text" class="text-lg leading-relaxed">${data.explanation.replace(/(①|②|③|④|⑤|⑥|⑦|⑧|⑨|⑩|'[^']+')/g, '<strong class="font-bold text-[#4CAF50]">$1</strong>')}</p>
                                </div>
                            </div>
                        </div>
                        <div id="meanings-list" class="grid grid-cols-1 gap-6"></div>
                    </div>
                </div>
            </section>
            <section id="vocabulary" class="content-section mb-24 md:mb-32">
                 <div class="max-w-5xl mx-auto">
                    <h2 class="text-4xl font-bold mb-8 text-left">📚 어휘</h2>
                    <div class="bg-white p-8 sm:p-10 rounded-lg shadow-lg">
                        <div id="vocabulary-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                    </div>
                </div>
            </section>
            <section id="advanced-vocab" class="content-section mb-16" style="${(!data.advancedVocabulary || data.advancedVocabulary.length === 0) ? 'display: none;' : ''}">
                <div class="max-w-5xl mx-auto">
                    <h2 class="text-4xl font-bold mb-8 text-left">🚀 도약</h2>
                    <div class="bg-white p-8 sm:p-10 rounded-lg shadow-lg">
                        <div id="advanced-vocabulary-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                    </div>
                </div>
            </section>`;
        
        const allErrors = getErrors();
        
        const setupContentCheckbox = (box, section, title) => {
            const uniqueId = `${data.id}-${section}-${title}`;
            box.dataset.uniqueId = uniqueId;
            box.dataset.hanjaId = data.id;
            box.dataset.section = section;
            box.dataset.word = title;
            box.checked = !!allErrors[uniqueId];
        };
        setupContentCheckbox(document.querySelector('#meaning-explanation-box .content-error-checkbox'), '해설', data.huneum);
        
        const renderItems = (container, dataList, cardCreator) => {
            if (container && dataList?.length > 0) container.innerHTML = dataList.map((item, index) => cardCreator(item, index)).join('');
        };
        
        const createMeaningCardHTML = (m, index) => {
            const uniqueId = `${data.id}-의미-${m.title}`;
            return `<div class="interactive-box kpi-card p-6" data-word="${m.title}" tabindex="0">
                <div class="flex items-start space-x-3">
                    <input type="checkbox" class="content-error-checkbox h-5 w-5 rounded border-gray-300 text-orange-600 focus:ring-orange-500 mt-1 flex-shrink-0"
                           data-unique-id="${uniqueId}" data-hanja-id="${data.id}" data-section="의미" data-word="${m.title}" ${allErrors[uniqueId] ? 'checked' : ''}>
                    <div>
                        <h3 class="text-xl font-bold mb-2 text-[#4CAF50]">${m.title}</h3>
                        <p class="text-gray-700">${m.definition.replace(/│/g, '')}</p>
                        <p class="text-sm italic text-gray-500 mt-2">예: ${m.example}</p>
                    </div>
                </div>
            </div>`;
        };
        
        const createVocabularyCardHTML = (v, index, isAdvanced = false) => {
            const section = isAdvanced ? '도약' : '어휘';
            const vocabTitle = isAdvanced ? v.word : v.title;
            const uniqueId = `${data.id}-${section}-${vocabTitle}`;
            
            const titleHTML = isAdvanced ? `<h3 class="text-2xl font-bold">${v.word}</h3>` : `<h3 class="text-2xl font-bold">${v.title.replace(/(\([^)]+\))/g, '<strong class="font-bold text-orange-600">$1</strong>')}</h3>`;
            const actionsHTML = `<div class="flex items-center">
                <button class="syllable-analysis-btn p-2 rounded-full hover:bg-gray-100" title="음절 분석"><svg class="w-6 h-6 text-gray-500"><use href="#icon-syllable-analysis"></use></svg></button>
                <button class="vocab-actions-toggle flex-shrink-0 p-2 -mr-2 rounded-full hover:bg-gray-100"><svg class="w-6 h-6 text-gray-500"><use href="#icon-more-vertical"></use></svg></button>
            </div>`;
            const linkHTML = isAdvanced ? `<a href="hanja-detail.html?id=${v.linkId}" class="vocab-link inline-flex items-center font-bold text-xs py-0.5 px-2 rounded-full" data-volume="${v.linkId.split('-')[0]}">${v.linkId.replace('-', '권_')} <svg class="w-5 h-5 ml-1"><use href="#icon-arrow-right"></use></svg></a>` : '';
            
            let detailsHTML;
            if (isAdvanced) {
                detailsHTML = `<div class="mt-4 pt-4 border-t border-gray-200 flex justify-between items-center">${linkHTML}${actionsHTML}</div>`;
            } else {
                detailsHTML = `<div class="vocab-details"><p><strong>뜻:</strong> ${v.definition}</p><p><strong>구성:</strong> ${v.composition}</p>${v.analysis ? `<p><strong>풀이:</strong> ${v.analysis}</p>` : ''}<p class="italic"><strong>예:</strong> ${v.example}</p></div>`;
            }

            return `<div class="kpi-card interactive-box relative p-6" data-word="${vocabTitle}">
                <div class="flex justify-between items-start">
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" class="content-error-checkbox h-5 w-5 rounded border-gray-300 text-orange-600 focus:ring-orange-500" 
                               data-unique-id="${uniqueId}" 
                               data-hanja-id="${data.id}" 
                               data-section="${section}" 
                               data-word="${vocabTitle}" 
                               ${allErrors[uniqueId] ? 'checked' : ''}>
                        ${titleHTML}
                    </div>
                    ${!isAdvanced ? actionsHTML : ''}
                </div>
                ${detailsHTML}
            </div>`;
        };

        renderItems(document.getElementById('meanings-list'), data.meanings, createMeaningCardHTML);
        renderItems(document.getElementById('vocabulary-list'), data.vocabulary, (v, i) => createVocabularyCardHTML(v, i, false));
        renderItems(document.getElementById('advanced-vocabulary-list'), data.advancedVocabulary, (v, i) => createVocabularyCardHTML(v, i, true));
    }
    
    function addAllEventListeners(hanjaData, allHanjaData) {
        document.querySelectorAll('.syllable-analysis-btn').forEach(btn => btn.addEventListener('click', (e) => handleSyllableAnalysis(e, allHanjaData)));
        document.querySelectorAll('.vocab-actions-toggle').forEach(btn => btn.addEventListener('click', (e) => handleActionsPopup(e)));
        document.querySelectorAll('.content-error-checkbox').forEach(box => box.addEventListener('change', (e) => handleErrorCheck(e, hanjaData)));

        const getBadgeColorClasses = (v) => ['','bg-red-200 text-red-800','bg-blue-200 text-blue-800','bg-green-200 text-green-800','bg-yellow-200 text-yellow-800','bg-indigo-200 text-indigo-800','bg-purple-200 text-purple-800','bg-pink-200 text-pink-800','bg-teal-200 text-teal-800','bg-slate-300 text-slate-800','bg-orange-300 text-orange-800'][parseInt(v, 10)] || '';
        document.querySelectorAll('.vocab-link').forEach(link => link.classList.add(...getBadgeColorClasses(link.dataset.volume).split(' ')));

        window.addEventListener('scroll', handleHeaderScroll, { passive: true });
        document.querySelectorAll('.modal-popup').forEach(modal => {
            modal.addEventListener('click', (e) => { if (e.target === modal) closeAllPopups(); });
        });
    }

    function closeAllPopups() {
        document.querySelectorAll('.modal-popup.open').forEach(p => p.classList.remove('open'));
    }
    
    function handleSyllableAnalysis(e, allHanjaData) {
        const card = e.currentTarget.closest('.kpi-card');
        const title = card.dataset.word;
        e.stopPropagation();
        
        const match = title.match(/([^\(]+)\(([^\)]+)\)/);
        if (!match) return;

        const [_, hangul, hanjaStr] = match;
        document.getElementById('syllable-modal').querySelector('.syllable-display').innerHTML = hangul.split('').map((hangulChar, i) => {
            const hanjaChar = hanjaStr[i];
            const linkedHanja = allHanjaData.find(item => item.hanja === hanjaChar);
            const content = `<div class="hangul">${hangulChar}</div><div class="hanja">${hanjaChar}</div>`;
            return linkedHanja
                ? `<a href="?id=${linkedHanja.id}" class="syllable-char-box block">${content}</a>`
                : `<a href="https://hanja.naver.com/search?query=${encodeURIComponent(hanjaChar)}" target="_blank" class="syllable-char-box block">${content}</a>`;
        }).join('');
        
        document.getElementById('syllable-modal').classList.add('open');
    }
    
    function handleActionsPopup(e) {
        const card = e.currentTarget.closest('.kpi-card');
        const title = card.dataset.word;
        e.stopPropagation();
        
        const actionsContent = document.getElementById('actions-modal').querySelector('.actions-popup-content');
        actionsContent.innerHTML = `
            <button class="ai-link p-3 rounded-full text-purple-500 hover:bg-gray-100" data-word="${title}"><svg class="w-8 h-8"><use href="#icon-ai-text"></use></svg></button>
            <button class="naver-dictionary-link p-3 rounded-full hover:bg-gray-100" data-word="${title}"><svg class="w-7 h-7 text-green-500"><use href="#icon-naver-dict"></use></svg></button>
            <button class="google-image-link p-3 rounded-full hover:bg-gray-100" data-word="${title}"><svg class="w-7 h-7 text-orange-500"><use href="#icon-google-img"></use></svg></button>`;
        
        actionsContent.querySelector('.ai-link').addEventListener('click', handleAiLink);
        actionsContent.querySelector('.naver-dictionary-link').addEventListener('click', (ev) => handleSearchLink(ev, 'https://hanja.naver.com/search?query='));
        actionsContent.querySelector('.google-image-link').addEventListener('click', (ev) => handleSearchLink(ev, 'https://www.google.com/search?tbm=isch&q='));

        document.getElementById('actions-modal').classList.add('open');
    }

    function handleHeaderScroll() {
        const topbar = document.getElementById('topbar');
        if (topbar) topbar.style.transform = window.scrollY > 10 ? 'translateY(-100%)' : 'translateY(0%)';
    }

    function handleSearchLink(e, baseUrl) {
        const title = e.currentTarget.dataset.word;
        if (title) {
            const query = e.currentTarget.classList.contains('google-image-link') ? title.replace(/\(.*\)/, '').trim() : title;
            window.open(`${baseUrl}${encodeURIComponent(query)}`, '_blank');
        }
    }

    async function handleAiLink(e) {
        const title = e.currentTarget.dataset.word;
        if (title) {
            try {
                await navigator.clipboard.writeText(title); 
                showToast('어휘가 클립보드에 복사되었습니다.'); 
                window.open('https://chatgpt.com/g/g-6tdiusZks-1-eosamun-wanggwanyujabos', '_blank');
            } catch (err) { showToast('클립보드 복사에 실패했습니다.', 'error'); }
        }
    }

    let toastTimeout;
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast-notification');
        toast.textContent = message;
        toast.className = `fixed bottom-10 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-lg z-50 ${type === 'error' ? 'bg-red-600' : 'bg-gray-800'} text-white show`;
        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => { toast.classList.remove('show'); }, 3000);
    }
    
    // [수정됨] 관련 없는 JS 코드 삭제
    function initializeIdFinder(allHanjaData) {
        const volumeInput = document.getElementById('search-volume');
        const numInVolumeInput = document.getElementById('search-number-in-volume');
        const gotoBtn = document.getElementById('goto-hanja-id-btn');

        if (!volumeInput || !numInVolumeInput || !gotoBtn) return;
        
        const handleGoToId = () => {
            const volume = volumeInput.value;
            const numInVolume = numInVolumeInput.value;
            let target = null;

            if (volume && numInVolume) {
                const targetId = `${volume}-${numInVolume}`;
                target = allHanjaData.find(item => item.id === targetId);
            }

            if (target) {
                window.location.search = `?id=${target.id}`;
            } else {
                showToast('유효한 권과 연번을 입력해주세요.', 'error');
            }
        };

        gotoBtn.addEventListener('click', handleGoToId);
        [volumeInput, numInVolumeInput].forEach(input => {
             input.addEventListener('keydown', (e) => { if (e.key === 'Enter') handleGoToId(); });
        });
    }

    function handleErrorCheck(event, currentHanjaData) {
        const checkbox = event.target;
        const { uniqueId } = checkbox.dataset;
        const errors = getErrors();
        
        if (checkbox.checked) {
            const ds = checkbox.dataset;
            errors[uniqueId] = {
                id: ds.hanjaId,
                hanja: currentHanjaData.hanja,
                huneum: currentHanjaData.huneum,
                errorItem: ds.word,
                errorLocation: ds.section,
                feedback: '',
                suggestion: '',
                memo: ''
            };
        } else {
            delete errors[uniqueId];
        }
        
        saveErrors(errors);
        renderAggregatedErrors();
    }
    
    function renderAggregatedErrors() {
        const container = document.getElementById('aggregated-errors-list');
        const sortMethod = document.getElementById('sort-errors-by').value;
        if (!container) return;
        
        const errors = getErrors();
        let errorItems = Object.entries(errors).map(([uniqueId, data]) => ({ uniqueId, ...data }));
        
        if (sortMethod === 'id-asc') {
            errorItems.sort((a, b) => a.id.localeCompare(b.id, undefined, {numeric: true}));
        } else if (sortMethod === 'section') {
            errorItems.sort((a, b) => a.errorLocation.localeCompare(b.errorLocation) || a.id.localeCompare(b.id, undefined, {numeric: true}));
        }

        if (errorItems.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-sm p-2">체크된 오류 항목이 없습니다.</p>';
            return;
        }

        container.innerHTML = errorItems.map(({ uniqueId, id, hanja, huneum, errorItem, errorLocation, feedback, suggestion, memo }) => `
            <div class="relative text-sm p-2 border-b last:border-b-0 bg-white">
                <button class="delete-error-btn absolute top-1 right-1 text-gray-400 hover:text-red-500 font-bold text-lg leading-none p-1" data-unique-id="${uniqueId}" title="삭제">&times;</button>
                <p class="font-bold pr-4">${errorItem} <span class="text-xs font-normal text-gray-500">(${errorLocation})</span></p>
                <p class="text-gray-600 text-xs">ID: ${id} (${hanja} ${huneum})</p>
                ${feedback ? `<p class="text-blue-600 text-xs mt-1">피드백: ${feedback}</p>` : ''}
                ${suggestion ? `<p class="text-green-600 text-xs mt-1">수정 제안: ${suggestion}</p>` : ''}
                <textarea class="error-memo-textarea" data-unique-id="${uniqueId}" placeholder="메모 입력...">${memo || ''}</textarea>
            </div>
        `).join('');
    }

    function initializeAggregatedErrors() {
        renderAggregatedErrors();

        document.getElementById('sort-errors-by').addEventListener('change', renderAggregatedErrors);
        
        document.getElementById('copy-aggregated-errors-btn').addEventListener('click', () => {
            const errors = getErrors();
            const errorItems = Object.values(errors);
            if (errorItems.length === 0) {
                showToast('복사할 오류 항목이 없습니다.', 'error');
                return;
            }
            const headers = "ID\t한자\t훈음\t오류 항목\t오류 위치\t피드백\t수정 제안\t메모";
            const tsvString = [headers, ...errorItems.map(e => `${e.id}\t${e.hanja}\t${e.huneum}\t${e.errorItem}\t${e.errorLocation}\t${e.feedback}\t${e.suggestion}\t${e.memo || ''}`)].join('\n');
            
            navigator.clipboard.writeText(tsvString).then(() => {
                showToast('오류 목록이 클립보드에 복사되었습니다.');
                window.open('https://docs.google.com/spreadsheets/d/1jJQIiQD0jKo7kE2JSP7-dlRgUosvU76sWWxor_HrASk/edit?gid=0#gid=0', '_blank');
            }, (err) => {
                showToast('복사에 실패했습니다.', 'error');
            });
        });

        document.getElementById('expand-errors-btn').addEventListener('click', () => {
            const errors = getErrors();
            const errorItems = Object.values(errors);
            if (errorItems.length === 0) {
                showToast('확장할 오류 항목이 없습니다.', 'error');
                return;
            }

            const newWindow = window.open('', '_blank');
            const headers = ["ID", "한자", "훈음", "오류 항목", "오류 위치", "피드백", "수정 제안", "메모"];
            let tableHTML = `<style>body{font-family:sans-serif;} table{width:100%; border-collapse:collapse;} th,td{border:1px solid #ccc; padding:8px; text-align:left; vertical-align:top;} th{background-color:#f2f2f2;}</style>
                             <h1>오류 취합 목록</h1>
                             <table><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
            
            errorItems.forEach(e => {
                tableHTML += `<tr>
                    <td>${e.id}</td><td>${e.hanja}</td><td>${e.huneum}</td><td>${e.errorItem}</td>
                    <td>${e.errorLocation}</td><td>${e.feedback}</td><td>${e.suggestion}</td><td>${(e.memo || '').replace(/\n/g, '<br>')}</td>
                </tr>`;
            });
            tableHTML += '</tbody></table>';

            newWindow.document.write(tableHTML);
            newWindow.document.close();
        });
        
        const errorListContainer = document.getElementById('aggregated-errors-list');

        errorListContainer.addEventListener('input', (e) => {
            if (e.target.classList.contains('error-memo-textarea')) {
                const uniqueId = e.target.dataset.uniqueId;
                const errors = getErrors();
                if (errors[uniqueId]) {
                    errors[uniqueId].memo = e.target.value;
                    saveErrors(errors);
                }
            }
        });
        
        errorListContainer.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-error-btn');
            if (deleteBtn) {
                const uniqueId = deleteBtn.dataset.uniqueId;
                const errors = getErrors();
                if (errors[uniqueId]) {
                    delete errors[uniqueId];
                    saveErrors(errors);

                    const correspondingCheckbox = document.querySelector(`.content-error-checkbox[data-unique-id="${uniqueId}"]`);
                    if (correspondingCheckbox) {
                        correspondingCheckbox.checked = false;
                    }
                    renderAggregatedErrors();
                    showToast('오류 항목이 삭제되었습니다.');
                }
            }
        });
    }
    
    function initializeReviewPanel(currentHanjaData, allHanjaData) {
        const reviewPanel = document.getElementById('review-panel');
        if (!reviewPanel) return;
        reviewPanel.style.display = 'block';
        
        const hanjaIdEl = document.getElementById('review-hanja-id');
        const progressEl = document.getElementById('review-progress');
        const prevBtn = document.getElementById('prev-hanja');
        const nextBtn = document.getElementById('next-hanja');
        
        const currentIndex = allHanjaData.findIndex(item => item.id === currentHanjaData.id);
        
        hanjaIdEl.textContent = `[${currentHanjaData.id.replace('-', '권_')}] ${currentHanjaData.serial}`;
        progressEl.textContent = `${currentIndex + 1} / ${allHanjaData.length}`;
        prevBtn.disabled = currentIndex === 0;
        nextBtn.disabled = currentIndex === allHanjaData.length - 1;

        const navigateToHanja = (id) => { window.location.search = `?id=${id}`; };
        prevBtn.onclick = () => { if (currentIndex > 0) navigateToHanja(allHanjaData[currentIndex - 1].id); };
        nextBtn.onclick = () => { if (currentIndex < allHanjaData.length - 1) navigateToHanja(allHanjaData[currentIndex + 1].id); };
    }

    function initializeAiReviewPanel(currentHanjaData) {
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        const modelSelect = document.getElementById('gemini-model-select');
        const promptTextarea = document.getElementById('ai-prompt-textarea');
        const savePromptBtn = document.getElementById('save-ai-prompt-btn');
        const runBtn = document.getElementById('run-ai-review-btn');

        if (!apiKeyInput || !saveApiKeyBtn || !runBtn) return;
        
        const defaultApiKey = 'AIzaSyB-WkWOgaTtwwTyp_qmCQFl_nWupcHhm6o';
        const savedApiKey = localStorage.getItem('geminiApiKey') || defaultApiKey;
        apiKeyInput.value = savedApiKey;
        runBtn.disabled = !savedApiKey;
        
        saveApiKeyBtn.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            localStorage.setItem('geminiApiKey', key);
            runBtn.disabled = !key;
            showToast(key ? 'API 키가 저장되었습니다.' : 'API 키가 삭제되었습니다.');
        });
        
        const defaultPrompt = `당신은 주어진 JSON 데이터를 검토하여 오류를 찾는 한국 한자 전문가입니다. 아래 6가지 유형의 오류를 찾아주세요. 오류가 없다면 빈 JSON 배열 []을 반환하세요.\n\n1.  **매칭 오류**: 'vocabulary'나 'advancedVocabulary'의 'title' 또는 'word'가 그 구성 한자와 의미적으로 맞지 않는 경우입니다. 'definition', 'composition', 'analysis' 필드를 종합적으로 고려하여 판단하세요. 동형어인 경우에 유의하세요.\n2.  **어원 해설의 학술적 타당성**: 'explanation' 내용이 어원적으로나 학술적으로 타당한지 검토하세요.\n3.  **뜻풀이 및 예문의 적절성**: 'meanings'와 'vocabulary' 섹션의 'definition'(뜻)과 'example'(예문)이 자연스럽고 정확한지 검토합니다.\n4.  **학습 어휘의 한자 구성 및 의미의 정확성**: 'composition' 필드가 어휘의 한자 구성과 의미를 정확하게 설명하는지 확인합니다.\n5.  **오탈자, 띄어쓰기, 문법 오류**: 모든 텍스트 필드에서 명백한 오탈자, 띄어쓰기, 문법적 오류를 찾으세요.\n6.  **한자 누락 또는 오기**: 한자가 잘못 표기되거나 누락된 경우를 찾으세요 (예: 十字架를 十字가로 표기).\n\n반드시 아래와 같은 JSON 배열 형식으로만 응답해야 합니다. 각 오류 항목은 JSON 객체로 표현해주세요.\n\n[\n  {\n    "identifier": "오류가 발견된 카드의 제목 (원본 데이터의 'huneum', 'title', 'word' 값을 그대로 사용)",\n    "errorItem": "실제 오류가 발생한 텍스트",\n    "errorLocation": "해설/의미/어휘/도약 중 하나",\n    "feedback": "오류에 대한 구체적인 설명",\n    "suggestion": "AI가 제안하는 수정안"\n  }\n]`;
        promptTextarea.value = localStorage.getItem('geminiUserPrompt') || defaultPrompt;
        
        savePromptBtn.addEventListener('click', () => {
            localStorage.setItem('geminiUserPrompt', promptTextarea.value);
            showToast('AI 명령어가 저장되었습니다.');
        });

        runBtn.addEventListener('click', async () => {
            const apiKey = localStorage.getItem('geminiApiKey');
            if (!apiKey) {
                showToast('API 키를 입력하고 저장해주세요.', 'error');
                return;
            }
            
            showToast('AI 검수를 시작합니다...');
            runBtn.disabled = true;
            runBtn.textContent = '검수 중...';

            document.querySelectorAll('.ai-feedback').forEach(el => el.remove());
            document.querySelectorAll('.ai-highlight').forEach(el => el.classList.remove('ai-highlight'));

            try {
                const model = modelSelect.value;
                const userPrompt = promptTextarea.value;
                const pageData = JSON.stringify(currentHanjaData, null, 2);
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: `${userPrompt}\n\n---\n\n${pageData}` }] }] };
                
                const response = await fetch(apiUrl, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API 요청 실패');
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!text) throw new Error('AI로부터 유효한 응답을 받지 못했습니다.');

                const jsonStringMatch = text.match(/\[[\s\S]*\]/);
                if (!jsonStringMatch) throw new Error('응답에서 JSON 배열을 찾을 수 없습니다.');
                
                const suggestions = JSON.parse(jsonStringMatch[0]);

                if (suggestions.length === 0) {
                    showToast('AI 검수 결과, 오류를 찾지 못했습니다.');
                } else {
                    suggestions.forEach(item => {
                        if (!item.identifier) {
                            console.warn('AI 응답에 identifier가 없습니다:', item);
                            return;
                        }

                        const feedbackHTML = `
                            <div class="ai-feedback mt-4 pt-4 border-t-2 border-dashed border-red-300">
                                <h4 class="font-bold text-red-600">🤖 AI 검수 결과</h4>
                                <p class="text-sm text-gray-800 mt-1"><strong>오류 내용:</strong> ${item.errorItem || 'N/A'}</p>
                                ${item.feedback ? `<p class="text-sm text-gray-700 mt-1"><strong>피드백:</strong> ${item.feedback}</p>` : ''}
                                ${item.suggestion ? `<p class="text-sm text-green-700 mt-1"><strong>수정 제안:</strong> ${item.suggestion}</p>` : ''}
                            </div>`;
                        
                        const identifier = item.identifier.trim();
                        const targetElement = Array.from(document.querySelectorAll('.kpi-card')).find(card => card.dataset.word && card.dataset.word.trim() === identifier);

                        if (targetElement) {
                            const contentWrapper = targetElement.querySelector('div > div');
                             if (contentWrapper) {
                                contentWrapper.insertAdjacentHTML('beforeend', feedbackHTML);
                            } else {
                                targetElement.insertAdjacentHTML('beforeend', feedbackHTML);
                            }
                            targetElement.classList.add('ai-highlight');
                        } else {
                             console.warn(`AI feedback for identifier "${identifier}" in section "${item.errorLocation}" could not be placed.`);
                        }
                    });
                    showToast(`${suggestions.length}개의 AI 제안을 표시했습니다.`);
                }
            } catch (error) {
                console.error('AI Review Error:', error);
                showToast(`오류 발생: ${error.message}`, 'error');
            } finally {
                runBtn.disabled = false;
                runBtn.textContent = 'AI 검수 실행';
            }
        });
    }
    </script>
</body>
</html>